app-id: com.valvesoftware.SteamLink
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: steamlink

finish_args:
  - --device=all
  - --env=LD_LIBRARY_PATH=/app/lib
  - "--env=SDL_GAMECONTROLLERCONFIG_FILE=/var/data/Valve Corporation/SteamLink/controller_map.txt"
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11

tags:
  - proprietary
  - beta

modules:
  - name: qt5-qtbase
    sources:
      - type: archive
        url: https://download.qt.io/archive/qt/5.14/5.14.1/submodules/qtbase-everywhere-src-5.14.1.tar.xz
        sha256: d9d423a6e7bcf1055c0372fc029f14a6fe67dd62c67b83095cde68b60b762cf7

      - type: patch
        path: patches/steamlink/qtbase.patch
        strip-components: 2

      # From org.kde.Sdk
      - type: patch
        path: patches/org.kde.Sdk/qtbase-avoid-hardcoding-kernel-version.patch
      - type: patch
        path: patches/org.kde.Sdk/qtbase-use-wayland-on-gnome.patch
      # Temporary fix for https://github.com/flatpak/flatpak/issues/3397
      - type: patch
        path: patches/org.kde.Sdk/qtbase-revert-correct-handling-for-xdg-runtime-dir.patch
      - type: patch
        path: patches/org.kde.Sdk/qtbase-make-sure-to-correctly-construct-base-platform-theme.patch
      - type: patch
        path: patches/org.kde.Sdk/open-file-portal-writable.patch
      - type: shell
        commands:
          - "mv configure configure.qt"
      - type: script
        commands:
          - "processed=`sed -e 's/--/-/g ; s/=/ /g' <<< $@`"
          - "./configure.qt $processed"
        dest-filename: configure

    # Cargo-culted from org.kde.Sdk
    build-options:
      arch:
        x86_64:
          config-opts:
            - "-reduce-relocations"
            - "-force-debug-info"
        arm:
          config-opts:
            - "-no-reduce-relocations"
            - "-optimize-size"
            - "-opengl es2"
        aarch64:
          config-opts:
            - "-no-reduce-relocations"
            - "-optimize-size"
            - "-opengl es2"
    config-opts: [
      "-confirm-license",
      "-opensource",
      "-shared",
      "-platform", "linux-g++",
      "-optimized-qmake",
      "-nomake", "examples",
      "-nomake", "tests",
      "-system-harfbuzz",
      "-system-sqlite",
      "-accessibility",
      "-dbus-linked",
      "-fontconfig",
      "-glib",
      "-icu",
      "-openssl-linked",
      "-no-pch",
      "-no-rpath",
      "-no-directfb",
      "-no-linuxfb",
      "-no-kms",
      "-system-proxies",
      "-gtk",
      "-no-use-gold-linker",
      "-no-cups",
      "-no-directfb",
      "-no-gbm",
      "-no-linuxfb",
      "-no-kms",
      "-archdatadir", "/app/lib/"
    ]
    cleanup:
      - /bin
      - /doc
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/*.prl
      - /lib/cmake
      - /lib/debug
      - /lib/mkspecs
      - /lib/pkgconfig

  - name: qt5-qtsvg
    buildsystem: qmake
    cleanup:
      - /bin
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/*.prl
      - /lib/cmake
      - /lib/debug
      - /lib/mkspecs
      - /lib/pkgconfig
    sources:
      - type: archive
        url: http://download.qt.io/archive/qt/5.14/5.14.1/submodules/qtsvg-everywhere-src-5.14.1.tar.xz
        sha256: 8540a57312f815f81a45b891b49959d776727fde17579bb6bf1a537996bc9359

  - name: chrpath
    sources:
      - type: archive
        url: https://deb.debian.org/debian/pool/main/c/chrpath/chrpath_0.16.orig.tar.gz
        sha256: bb0d4c54bac2990e1bdf8132f2c9477ae752859d523e141e72b3b11a12c26e7b
    cleanup:
      - '*'

  - name: steamlink-dependencies
    sources:
      - type: archive
        #url: https://.../steamlink-flatpak-0.20210210.0.tgz
        path: _source/steamlink-flatpak-0.20210210.0.tgz
        sha256: 55184c8ff9cf96c5574da4e568488eedb28ed5369b9a5f9f0daea8a2c384a911
    buildsystem: simple
    build-commands:
      # This is wrong, but the ABIs are close enough...
      - "ln -s /usr/lib/x86_64-linux-gnu/libudev.so.1 /app/lib/libudev.so.0"
      - "cp -a *.txt ThirdPartyLegalNotices.* /app"
      - "cp -a lib/* /app/lib"

  - name: steamlink-binary
    sources:
      - type: archive
        #url: ...
        path: _source/steamlink-1.1.71.173.tar.gz
        sha256: 8a0dc3ff7525cb646368429dd7aeb41407c621d7393ecd90326fe8edccf0e235
        strip-components: 0
    buildsystem: simple
    build-commands:
      - "cp -a steamlink /app/bin"
      - "chrpath -d /app/bin/steamlink"

  - name: packaging
    sources:
      - type: file
        path: com.valvesoftware.SteamLink.appdata.xml
      - type: file
        path: com.valvesoftware.SteamLink.desktop
      - type: dir
        path: icons
    buildsystem: simple
    build-commands:
      - install -d /app/share/applications/
      - install -d /app/share/metainfo/
      - install -D -m644 com.valvesoftware.SteamLink.appdata.xml /app/share/metainfo/
      - install -D -m644 com.valvesoftware.SteamLink.desktop /app/share/applications/
      - |
        set -eu; for size in 16 24 32 48 256; do
          src="$size/steamlink.png"
          dst="/app/share/icons/hicolor/${size}x${size}/apps/${FLATPAK_ID}.png"
          install -D -m644 "$src" "$dst"
        done
