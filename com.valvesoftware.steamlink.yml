app-id: com.valvesoftware.steamlink
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: steamlink

finish_args:
  - --device=all
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11

tags:
  - proprietary
  - beta

modules:
  - name: qt5-qtbase
    sources:
      - type: archive
        url: https://download.qt.io/archive/qt/5.14/5.14.1/submodules/qtbase-everywhere-src-5.14.1.tar.xz
        sha256: d9d423a6e7bcf1055c0372fc029f14a6fe67dd62c67b83095cde68b60b762cf7

      - type: patch
        path: patches/steamlink/qtbase.patch
        strip-components: 2

      # From org.kde.Sdk
      - type: patch
        path: patches/org.kde.Sdk/qtbase-avoid-hardcoding-kernel-version.patch
      - type: patch
        path: patches/org.kde.Sdk/qtbase-use-wayland-on-gnome.patch
      # Temporary fix for https://github.com/flatpak/flatpak/issues/3397
      - type: patch
        path: patches/org.kde.Sdk/qtbase-revert-correct-handling-for-xdg-runtime-dir.patch
      - type: patch
        path: patches/org.kde.Sdk/qtbase-make-sure-to-correctly-construct-base-platform-theme.patch
      - type: patch
        path: patches/org.kde.Sdk/open-file-portal-writable.patch
      - type: shell
        commands:
          - "mv configure configure.qt"
      - type: script
        commands:
          - "processed=`sed -e 's/--/-/g ; s/=/ /g' <<< $@`"
          - "./configure.qt $processed"
        dest-filename: configure

    # Cargo-culted from org.kde.Sdk
    build-options:
      arch:
        x86_64:
          config-opts:
            - "-reduce-relocations"
            - "-force-debug-info"
        arm:
          config-opts:
            - "-no-reduce-relocations"
            - "-optimize-size"
            - "-opengl es2"
        aarch64:
          config-opts:
            - "-no-reduce-relocations"
            - "-optimize-size"
            - "-opengl es2"
    config-opts: [
      "-confirm-license",
      "-opensource",
      "-shared",
      "-platform", "linux-g++",
      "-optimized-qmake",
      "-nomake", "examples",
      "-nomake", "tests",
      "-system-harfbuzz",
      "-system-sqlite",
      "-accessibility",
      "-dbus-linked",
      "-fontconfig",
      "-glib",
      "-icu",
      "-openssl-linked",
      "-no-pch",
      "-no-rpath",
      "-no-directfb",
      "-no-linuxfb",
      "-no-kms",
      "-system-proxies",
      "-gtk",
      "-no-use-gold-linker",
      "-archdatadir", "/app/lib/"
    ]
    cleanup:
      - /bin
      - /doc
      - /include
      - /lib/*.a
      - /lib/*.la
      - /lib/*.prl
      - /lib/cmake
      - /lib/debug
      - /lib/mkspecs
      - /lib/pkgconfig

  # TODO: Compile the libraries we need, instead of pulling in prebuilt
  # binaries from the scout runtime.
  - name: scout
    sources:
      - type: archive
        url: https://repo.steampowered.com/steamrt-images-scout/snapshots/0.20210126.2/steam-runtime.tar.xz
        sha256: edc40f253300890d7721c22e4d41e94840a037cca94d0e78676990e31836d270
    buildsystem: simple
    build-commands:
      - "install -d /app/lib"

      # Direct dependencies
      - "install -D -m644 lib/x86_64-linux-gnu/libcrypto.so.1.0.0 /app/lib"
      - "install -D -m644 lib/x86_64-linux-gnu/libssl.so.1.0.0 /app/lib"
      - "install -D -m644 lib/x86_64-linux-gnu/libudev.so.0 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libcurl-gnutls.so.4 /app/lib"

      # Transitive dependencies, mostly from libcurl-gnutls.so.4
      - "install -D -m644 lib/x86_64-linux-gnu/libgcrypt.so.11 /app/lib"
      - "install -D -m644 lib/x86_64-linux-gnu/libkeyutils.so.1 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libgssapi_krb5.so.2 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libhogweed.so.4 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libidn.so.11 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libk5crypto.so.3 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libkrb5.so.3 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libkrb5support.so.0 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/libnettle.so.6 /app/lib"
      - "install -D -m644 usr/lib/x86_64-linux-gnu/librtmp.so.0 /app/lib"

  - name: steam
    sources:
      - type: archive
        url: https://repo.steampowered.com/steam/archive/stable/steam_1.0.0.68.tar.gz
        sha256: 65e882623c671f402d8796c1db4407984f11df0538ff7462030d8d521aeb28d3
    buildsystem: simple
    build-commands:
      - |
        set -eu; for size in 16 24 32 48 256; do
          src="icons/$size/steam.png"
          dst="/app/share/icons/hicolor/${size}x${size}/apps/${FLATPAK_ID}.png"
          install -D -m644 "$src" "$dst"
        done

  - name: steamlink
    sources:
      - type: archive
        #url: https://.../steamlink-amd64.tgz
        path: _source/steamlink-amd64.tgz
        sha256: 774c0542e9ab428bbda227189939871bcece7a3390b48eed2ba40c5b205b7199
    buildsystem: simple
    build-commands:
      - "install -d /app/lib/steamlink"
      - "cp -a * /app/lib/steamlink"
      - "rm -fr /app/lib/steamlink/Qt-*"

  - name: packaging
    sources:
      - type: file
        path: com.valvesoftware.steamlink.appdata.xml
      - type: file
        path: com.valvesoftware.steamlink.desktop
      - type: file
        path: wrapper.sh
    buildsystem: simple
    build-commands:
      - install -d /app/share/applications/
      - install -d /app/share/metainfo/
      - install -D -m644 com.valvesoftware.steamlink.appdata.xml /app/share/metainfo/
      - install -D -m644 com.valvesoftware.steamlink.desktop /app/share/applications/
      - install -D -m755 wrapper.sh /app/bin/steamlink
